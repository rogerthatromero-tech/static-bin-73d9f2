<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Camo – Flavor 3D Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Model Viewer -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }

      .viewer-wrapper {
        width: 100%;
        height: 100%;
      }

      model-viewer {
        width: 100%;
        height: 100%;
        --poster-color: #000000;
        background-color: #000000;
      }
    </style>
  </head>
  <body>
    <div class="viewer-wrapper">
      <model-viewer
        id="camo-viewer"
        alt="Camo flavor 3D model"
        camera-controls
        autoplay
        shadow-intensity="1"
        exposure="1.1"
        environment-image="neutral"
        disable-zoom="false"
        interaction-prompt="none"
      >
      </model-viewer>
    </div>

    <script>
      (function () {
        const viewer = document.getElementById("camo-viewer");

        // 1) Get model URL from ?model=... (Shopify iframe src should add this)
        const params = new URLSearchParams(window.location.search);
        const modelFromQuery = params.get("model");

        // Fallback: if no query param, you can hardcode a default here:
        const fallbackModel = "assets/models/cacao.glb";

        const modelUrl = modelFromQuery || fallbackModel;

        // Set the model source
        viewer.src = modelUrl;

        // 2) Intro animation when the model finishes loading
        viewer.addEventListener("load", () => {
          runIntroAnimation(viewer);
        });

        function runIntroAnimation(el) {
          // Stop any previous animation logic
          let startTime = null;
          const duration = 2200; // ms

          // starting + ending camera-orbit values
          const startTheta = -150; // behind / off to the side
          const endTheta = 210; // spin around to front (total 360° spin)
          const startRadius = 3.0; // farther away
          const endRadius = 1.8; // closer
          const phi = 70; // vertical angle

          function easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
          }

          function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            let t = elapsed / duration;

            if (t > 1) t = 1;
            const e = easeInOutQuad(t);

            const theta = startTheta + (endTheta - startTheta) * e;
            const radius = startRadius + (endRadius - startRadius) * e;

            const orbit = `${theta}deg ${phi}deg ${radius}m`;
            el.setAttribute("camera-orbit", orbit);

            if (t < 1) {
              requestAnimationFrame(step);
            } else {
              // Final “rest” position straight on
              el.setAttribute("camera-orbit", `0deg ${phi}deg ${endRadius}m`);

              // Optional: slow continuous rotation afterward
              el.setAttribute("auto-rotate", "");
              el.setAttribute("auto-rotate-delay", "2000");
            }
          }

          // Reset rotation + stop built-in auto-rotate while we play intro
          el.removeAttribute("auto-rotate");
          el.setAttribute("camera-orbit", `${startTheta}deg ${phi}deg ${startRadius}m`);

          requestAnimationFrame(step);
        }
      })();
    </script>
  </body>
</html>
