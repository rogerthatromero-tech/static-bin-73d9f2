<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Camo – Flavor 3D Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Model Viewer -->
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }

      .viewer-wrapper {
        width: 100%;
        height: 100%;
      }

      model-viewer {
        width: 100%;
        height: 100%;
        --poster-color: #000000;
      }
    </style>
  </head>
  <body>
    <div class="viewer-wrapper">
      <model-viewer
        id="flavor-viewer"
        src=""
        alt="Flavor 3D model"
        camera-controls
        /* we’ll control auto-rotate via JS */
        exposure="1.1"
        shadow-intensity="1"
        environment-image="neutral"
        interaction-prompt="none"
        camera-orbit="0deg 60deg 1.6m"
      >
      </model-viewer>
    </div>

    <script>
      // --- 1. Pick model URL from ?model= (Shopify passes this) ---

      const params = new URLSearchParams(window.location.search);
      const modelFromParam = params.get("model");

      // Your default model if no ?model= is provided:
      const defaultModel =
        "https://cdn.shopify.com/3d/models/c3984cd92fb8c51e/cacao.glb";

      let modelUrl;

      if (modelFromParam && modelFromParam.trim() !== "") {
        // If Shopify passes a full URL (https://...)
        if (modelFromParam.startsWith("http")) {
          modelUrl = modelFromParam;
        } else {
          // If it’s a relative path, make it absolute relative to this page
          modelUrl = new URL(modelFromParam, window.location.origin).href;
        }
      } else {
        modelUrl = defaultModel;
      }

      const viewer = document.querySelector("#flavor-viewer");
      viewer.src = modelUrl;

      // --- 2. Sketchfab-style entrance animation + auto-rotate control ---

      let entranceDone = false;
      let autoRotateResumeTimeout = null;

      // We'll manage auto-rotate via JS
      viewer.autoRotate = false;
      viewer.autoRotateDelay = 3000; // ms after restart

      function runEntranceAnimation() {
        if (entranceDone) return;
        entranceDone = true;

        const duration = 2500; // ms
        const startTime = performance.now();

        // Start: behind + higher + further away
        const startTheta = 220; // deg around model
        const endTheta = 0; // front

        const startPhi = 70; // vertical angle (top-down)
        const endPhi = 60;

        const startRadius = 2.8; // distance from model (meters)
        const endRadius = 1.6;

        function step(now) {
          const t = Math.min((now - startTime) / duration, 1);

          // ease in-out cubic
          const ease =
            t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;

          const theta = startTheta + (endTheta - startTheta) * ease;
          const phi = startPhi + (endPhi - startPhi) * ease;
          const radius = startRadius + (endRadius - startRadius) * ease;

          viewer.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;

          if (t < 1) {
            requestAnimationFrame(step);
          } else {
            // When entrance finishes, begin slow auto-rotate
            viewer.autoRotate = true;
          }
        }

        requestAnimationFrame(step);
      }

      // Pause auto-rotate on user interaction, then resume after idle
      function handleUserInteraction() {
        // stop any scheduled resume
        if (autoRotateResumeTimeout) {
          clearTimeout(autoRotateResumeTimeout);
          autoRotateResumeTimeout = null;
        }

        // stop spinning while user is interacting
        viewer.autoRotate = false;

        // schedule resume after some idle time
        autoRotateResumeTimeout = setTimeout(() => {
          viewer.autoRotate = true;
        }, 8000); // 8s after last interaction
      }

      // Attach interaction listeners
      ["pointerdown", "pointerup", "wheel", "keydown", "touchstart", "touchend"].forEach(
        (eventName) => {
          viewer.addEventListener(eventName, handleUserInteraction);
        }
      );

      // When the 3D model is ready, kick off the entrance animation
      viewer.addEventListener("load", () => {
        // ensure we start from the "behind" pose before animating
        viewer.cameraOrbit = "220deg 70deg 2.8m";

        // Tiny delay so the model is fully rendered before we start moving
        setTimeout(runEntranceAnimation, 200);
      });
    </script>
  </body>
</html>
